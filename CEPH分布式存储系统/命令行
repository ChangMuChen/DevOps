yum install wget -y
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
wget -P /etc/yum.repos.d/ http://mirrors.aliyun.com/repo/epel-7.repo
yum clean all 
yum makecache

yum install ntp ntpdate ntp-doc vim ansible yum-plugin-priorities ceph-mgr-dashboard -y
yum update -y
systemctl enable ntpd
systemctl start ntpd
firewall-cmd --zone=public --add-port=80-19999/tcp --permanent
firewall-cmd --reload

cat << EOM > /etc/hosts
192.168.40.129 node1
192.168.40.130 node2
192.168.40.131 node3
EOM


cat << EOM > /etc/yum.repos.d/ceph.repo
[ceph-noarch]
name=Ceph noarch packages
baseurl=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7/noarch/
enabled=1
gpgcheck=1
type=rpm-md
gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc
EOM
yum update -y
yum clean all 
yum makecache

export CEPH_DEPLOY_REPO_URL=https://mirrors.aliyun.com/ceph/rpm-nautilus/el7
export CEPH_DEPLOY_GPG_URL=https://mirrors.aliyun.com/ceph/keys/release.asc

ssh-keygen
ssh-copy-id root@node1
sudo setenforce 0
vim /etc/selinux/config

cat << EOM > ~/.ssh/config
Host node1
   Hostname node1
   User root
Host node2
   Hostname node2
   User root
Host node3
   Hostname node3
   User root
EOM

sudo yum update -y
sudo yum install ceph-deploy -y

mkdir my-cluster
cd my-cluster
ceph-deploy new --cluster-network 192.168.40.0/24 --public-network 192.168.40.0/24 node{1,2,3}
ceph-deploy install node1 node2 node3

ceph-deploy mon create-initial
ceph-deploy admin node1 node2 node3
ceph-deploy mgr create node1 node2 node3
--
ceph-deploy osd create --data /dev/sdb node1
ceph-deploy osd create --data /dev/sdc node1
ceph-deploy osd create --data /dev/sdb node2
ceph-deploy osd create --data /dev/sdc node2
ceph-deploy osd create --data /dev/sdb node3
ceph-deploy osd create --data /dev/sdc node3

ceph-deploy mds create node1 node2 node3

ceph-deploy rgw create node1 //--default port 7480
radosgw-admin user create --uid=root --display-name=root --system
  "keys": [
        {
            "user": "root",
            "access_key": "QJFIYJPWV3DYDW1YUZ91",
            "secret_key": "wHeehXLY6tPhGsIGAphSuq0Dmi9L0aHOgjuh6lcc"
        }
    ],


ceph mgr module enable dashboard
ceph config set mgr mgr/dashboard/ssl false
ceph mgr module disable dashboard
ceph mgr module enable dashboard

ceph config set mgr mgr/dashboard/server_addr 192.168.40.129
ceph config set mgr mgr/dashboard/server_port 8080


ceph config set mgr mgr/dashboard/node1/server_addr 192.168.40.129
ceph config set mgr mgr/dashboard/node1/server_port 8080

ceph config set mgr mgr/dashboard/node2/server_addr 192.168.40.130
ceph config set mgr mgr/dashboard/node2/server_port 8080

ceph config set mgr mgr/dashboard/node3/server_addr 192.168.40.131
ceph config set mgr mgr/dashboard/node3/server_port 8080

ceph dashboard ac-user-create admin 123456 administrator

ceph dashboard set-rgw-api-access-key QJFIYJPWV3DYDW1YUZ91
ceph dashboard set-rgw-api-secret-key wHeehXLY6tPhGsIGAphSuq0Dmi9L0aHOgjuh6lcc
ceph dashboard set-rgw-api-host 192.168.40.129
ceph dashboard set-rgw-api-port 7480
ceph dashboard set-rgw-api-ssl-verify False
